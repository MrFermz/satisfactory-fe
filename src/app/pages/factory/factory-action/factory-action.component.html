<div class="factory container-fluid">
  <button
    [routerLink]="['/factory']"
    pButton
    label="Back"
  ></button>
  <button
    (click)="addBuilding()"
    pButton
    class="p-button-success"
    icon="pi pi-plus"
  ></button>
  <button
    (click)="onSave()"
    pButton
    class="p-button-secondary"
    label="Save"
  ></button>
  <button
    (click)="onSave(true)"
    pButton
    class="p-button-warning"
    label="Save and Exit"
  ></button>

  <div class="mt-5">
    <div>
      <label>Locked ?</label>
      <p-inputSwitch [(ngModel)]="factoryLocked"></p-inputSwitch>
    </div>
    <div>
      <label for="name">Name</label>
      <input [(ngModel)]="factoryName" type="text" id="name" pInputText>
    </div>
    <div>
      <label>Count: {{factoryData.length}}</label>
    </div>
    <div>
      <label>Input: {{sumBy(factoryData, 'inputRate')}}</label>
    </div>
    <div>
      <label>Output: {{sumBy(factoryData, 'outputRate')}}</label>
    </div>
    <div>
      <p-table [value]="factoryData" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th [width]="100">Mk.</th>
            <th>Purity</th>
            <th [width]="200">Input</th>
            <th [width]="200">Output</th>
            <th>Action</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-factory let-i="rowIndex">
          <tr>
            <td>{{i+1}}</td>
            <td>
              <p-dropdown
                (onChange)="onChangeBuilding($event, i)"
                [(ngModel)]="factory.building"
                [options]="buidingData"
                [filter]="true"
                [showClear]="true"
                optionLabel="name"
                filterBy="name"
                placeholder="Select a building."
              ></p-dropdown>
            </td>
            <td>
              <div *ngIf="factory?.building?.markList && factory?.building?.markList.length > 0">
                <p-inputNumber
                  (onInput)="onInputMk($event, i)"
                  [(ngModel)]="factory.mk"
                  [showButtons]="true"
                  [min]="factory.building.markList[0]"
                  [max]="factory.building.markList[factory.building.markList.length - 1]"
                  buttonLayout="horizontal"
                  decrementButtonClass="p-button-danger"
                  incrementButtonClass="p-button-success"
                  decrementButtonIcon="pi pi-minus"
                  incrementButtonIcon="pi pi-plus"
                ></p-inputNumber>
              </div>
              <div *ngIf="!factory?.building?.markList || factory?.building?.markList.length === 0">-</div>
            </td>
            <td>
              <div *ngIf="factory?.building?.haveQuality">
                <p-selectButton
                  (onChange)="onChangeQuality($event, i)"
                  [options]="qualityArr"
                  [(ngModel)]="factory.quality"
                  optionLabel="name"
                  optionValue="value"
                ></p-selectButton>
              </div>
              <div *ngIf="!factory?.building?.haveQuality">-</div>
            </td>
            <td>
              <div *ngIf="factory?.building?.input">
                <div *ngFor="let input of numSequence(factory.building.input); let j = index">
                  <div class="p-inputgroup" *ngIf="factory['input'+j]?.inputRate">
                    <button
                      *ngIf="factory['input'+j].inputRate !== factory['input'+j].originalInputRate"
                      (click)="onResetInputRate(i)"
                      type="button"
                      class="p-button-primary"
                      pButton pRipple
                      icon="pi pi-refresh"
                    ></button>
                    <p-inputNumber
                      [(ngModel)]="factory['input'+j].inputRate"
                    ></p-inputNumber>
                    <span class="p-inputgroup-addon">/min</span>
                  </div>
                  <p-dropdown
                    *ngIf="factory['input'+j]?.inputId"
                    (onChange)="onChangeInput($event, i, j)"
                    [(ngModel)]="factory['input'+j].inputId"
                    [options]="itemDataFiltered(factory.building.id, 'inProduced')"
                    [filter]="true"
                    [showClear]="true"
                    optionLabel="name"
                    filterBy="name"
                    placeholder="Select an items."
                  ></p-dropdown>
                  <p-dropdown
                    *ngIf="!factory['input'+j]?.inputId"
                    (onChange)="onChangeInput($event, i, j)"
                    [options]="itemDataFiltered(factory.building.id, 'inProduced')"
                    [filter]="true"
                    [showClear]="true"
                    optionLabel="name"
                    filterBy="name"
                    placeholder="Select an items."
                  ></p-dropdown>
                </div>
              </div>
              <div *ngIf="!factory?.building?.input">-</div>
            </td>
            <td>
              <div *ngIf="factory?.building?.output">
                <div *ngFor="let output of numSequence(factory.building.output)">
                  <div class="p-inputgroup" *ngIf="factory.outputRate">
                    <button
                      *ngIf="factory.outputRate !== factory.originalOutputRate"
                      (click)="onResetOutputRate(i)"
                      type="button"
                      class="p-button-primary"
                      pButton pRipple
                      icon="pi pi-refresh"
                    ></button>
                    <p-inputNumber
                      [(ngModel)]="factory.outputRate"
                    ></p-inputNumber>
                    <span class="p-inputgroup-addon">/min</span>
                  </div>
                  <p-dropdown
                    (onChange)="onChangeOutput($event, i)"
                    [(ngModel)]="factory.outputId"
                    [options]="itemDataFiltered(factory.building.id, 'outProduced')"
                    [filter]="true"
                    [showClear]="true"
                    optionLabel="name"
                    optionValue="id"
                    filterBy="name"
                    placeholder="Select an items."
                  ></p-dropdown>
                </div>
              </div>
              <div *ngIf="!factory?.building?.output">-</div>
            </td>
            <td>
              <button
                (click)="onCloneBuilding(i)"
                class="p-button-primary"
                icon="pi pi-clone"
                pButton
              ></button>
              <button
                (click)="onDeleteBuildingConfirm($event, i)"
                class="p-button-danger"
                icon="pi pi-trash"
                pButton
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<p-confirmPopup></p-confirmPopup>